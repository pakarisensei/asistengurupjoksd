document.addEventListener('DOMContentLoaded', () => {
    const domElements = {
        mainView: document.getElementById('main-view'),
        generateBtn: document.getElementById('generate-btn'),
        outputContainer: document.getElementById('output-modul'),
        placeholder: document.getElementById('placeholder'),
        actionButtons: document.getElementById('action-buttons'),
        copyBtn: document.getElementById('copy-btn'),
        backBtn: document.getElementById('back-btn'),
        faseSelect: document.getElementById('fase'),
        kelasSelect: document.getElementById('kelas'),
        materiPembelajaranSelect: document.getElementById('materi-pembelajaran'),
        elemenCpSelect: document.getElementById('elemen-cp'),
        geminiFeaturesSection: document.getElementById('gemini-features'),
        geminiModal: document.getElementById('gemini-modal'),
        geminiModalTitle: document.getElementById('gemini-modal-title'),
        geminiModalContent: document.getElementById('gemini-modal-content'),
        geminiModalClose: document.getElementById('gemini-modal-close'),
        geminiModalCopy: document.getElementById('gemini-modal-copy'),
        geminiWarmupBtn: document.getElementById('gemini-warmup-btn'),
        geminiMateriBtn: document.getElementById('gemini-materi-btn'),
        geminiQuizBtn: document.getElementById('gemini-quiz-btn'),
        geminiCodingBtn: document.getElementById('gemini-coding-btn')
    };

    const capaianPerElemen = { 'Terampil Bergerak': { A: "Peserta didik mempraktikkan keterampilan gerak fundamental dan menerapkannya dalam berbagai situasi gerak yang berbeda. Peserta didik mengeksplorasi berbagai cara menggerakkan tubuh. Peserta didik memanipulasi objek dengan bagian tubuh dan dalam ruang yang berbeda, serta menyimpulkan efektivitasnya.", B: "Peserta didik menghaluskan keterampilan gerak fundamental dan menerapkannya dalam situasi gerak yang baru. Peserta didik menerapkan dan menyesuaikan strategi gerak untuk mendapatkan capaian keterampilan gerak. Peserta didik memeragakan konsep gerak yang dapat diterapkan dalam rangkaian gerak.", C: "Peserta didik menyesuaikan dan memodifikasi keterampilan gerak melintasi berbagai situasi gerak. Peserta didik mentransfer strategi gerak yang sudah dikuasai ke dalam berbagai situasi gerak yang berbeda. Peserta didik menginvestigasi berbagai konsep gerak yang dapat diterapkan untuk meningkatkan capaian keterampilan gerak." }, 'Belajar melalui Gerak': { A: "Peserta didik mentaati dan menerapkan peraturan untuk mengembangkan fair play di dalam berbagai aktivitas jasmani. Peserta didik menerapkan strategi kolaborasi ketika berpartisipasi dalam aktivitas jasmani.", B: "Peserta didik menerapkan strategi gerak sederhana dan memecahkan masalah gerak. Peserta didik menyusun bersama dan menerapkan peraturan untuk mengembangkan fair play ketika berpartisipasi atau merancang aktivitas jasmani. Peserta didik mempertunjukkan berbagai peran dengan cara yang terhormat untuk mendapatkan keberhasilan capaian di dalam aktivitas gerak kelompok atau tim.", C: "Peserta didik memprediksi dan menguji efektivitas penerapan strategi gerak dalam berbagai situasi gerak. Peserta didik merancang dan menguji peraturan alternatif dan modifikasi permainan untuk mendukung fair play dan partisipasi inklusif. Peserta didik berpartisipasi secara positif dalam kelompok atau tim dengan memberi kontribusi pada aktivitas kelompok, mendorong orang lain dan menegosiasikan peran dan tanggung jawab." }, 'Bergaya Hidup Aktif': { A: "Peserta didik berpartisipasi di dalam berbagai aktivitas jasmani dan mengeksplorasi manfaatnya.", B: "Peserta didik berpartisipasi dalam berbagai aktivitas jasmani dan mengenali faktor-faktor yang menyebabkan aktivitas jasmani menyenangkan.", C: "Peserta didik berpartisipasi dalam aktivitas jasmani untuk menggambarkan pengaruh aktivitas jasmani yang teratur terhadap kesehatan. Peserta didik berpartisipasi dalam aktivitas jasmani di luar ruang dan/atau lingkungan alam dan menggambarkan faktor-faktor yang mempengaruhi partisipasi, baik secara pribadi maupun kelompok. Peserta didik mengeksplorasi rekomendasi aktivitas jasmani serta pencegahan perilaku sedenter dan membahas strategi pencapaiannya." }, 'Memilih Hidup yang Menyehatkan': { A: "Peserta didik mengenali gaya hidup aktif dan sehat, manfaat komponen makanan bergizi seimbang dan informasi gizi pada produk makanan yang berdampak pada kesehatan, situasi dan potensi yang berisiko terhadap kesehatan dan keselamatan dan strategi mencari bantuan kepada orang dewasa terpercaya.", B: "Peserta didik mengenali risiko kesehatan akibat gaya hidup dan berbagai aktivitas jasmani untuk pencegahannya, mengeksplorasi pola makan sehat dan bergizi seimbang sesuai rekomendasi kesehatan untuk menunjang aktivitas sehari-hari, serta mempraktikkan penanganan cedera ringan sesuai pemahaman tentang prinsip pertolongan pertama.", C: "Peserta didik mengidentifikasi risiko kesehatan akibat gaya hidup dan pencegahan melalui aktivitas jasmani berdasarkan rekomendasi otoritas kesehatan, memilih makanan sehat untuk menunjang aktivitas jasmani berdasarkan informasi kandungan gizi pada makanan, dan mempraktikkan penanganan cedera sedang sesuai pemahaman tentang prinsip pertolongan pertama." } };
    const materiByKelas = {
        '1': { 'lokomotor-1': { text: 'Aktivitas Pola Gerak Dasar Lokomotor', elemenTerkait: 'Terampil Bergerak'}, 'nonlokomotor-1': { text: 'Aktivitas Pola Gerak Dasar Nonlokomotor', elemenTerkait: 'Terampil Bergerak'}, 'manipulatif-1': { text: 'Aktivitas Pola Gerak Dasar Manipulatif', elemenTerkait: 'Terampil Bergerak'}, 'senam-1': { text: 'Aktivitas Senam', elemenTerkait: 'Terampil Bergerak'}, 'ritmik-1': { text: 'Aktivitas Gerak Berirama', elemenTerkait: 'Terampil Bergerak'}, 'air-1': { text: 'Aktivitas Pengenalan Air', elemenTerkait: 'Terampil Bergerak'}, 'kebugaran-1': { text: 'Aktivitas Kebugaran Jasmani', elemenTerkait: 'Bergaya Hidup Aktif' }, 'hidup-sehat-1': { text: 'Mengenal Gaya Hidup Sehat', elemenTerkait: 'Memilih Hidup yang Menyehatkan'} }, 
        '2': { 'lokomotor-2': { text: 'Aktivitas Pola Gerak Dasar Lokomotor', elemenTerkait: 'Terampil Bergerak'}, 'nonlokomotor-2': { text: 'Aktivitas Pola Gerak Dasar Nonlokomotor', elemenTerkait: 'Terampil Bergerak'}, 'manipulatif-2': { text: 'Aktivitas Pola Gerak Dasar Manipulatif', elemenTerkait: 'Terampil Bergerak'}, 'senam-2': { text: 'Aktivitas Gerak Dominan Senam', elemenTerkait: 'Terampil Bergerak'}, 'ritmik-2': { text: 'Aktivitas Gerak Berirama', elemenTerkait: 'Terampil Bergerak'}, 'air-2': { text: 'Aktivitas Pengenalan Air', elemenTerkait: 'Terampil Bergerak'}, 'kebugaran-2': { text: 'Aktivitas Kebugaran Jasmani', elemenTerkait: 'Bergaya Hidup Aktif' }, 'fair-play-2': { text: 'Menerapkan Fair Play', elemenTerkait: 'Belajar melalui Gerak'} }, 
        '3': { 'variasi-lokomotor-3': { text: 'Aktivitas Variasi Gerak Dasar Lokomotor', elemenTerkait: 'Terampil Bergerak'}, 'variasi-nonlokomotor-3': { text: 'Aktivitas Variasi Gerak Dasar Nonlokomotor', elemenTerkait: 'Terampil Bergerak'}, 'variasi-manipulatif-3': { text: 'Aktivitas Variasi Gerak Dasar Manipulatif', elemenTerkait: 'Terampil Bergerak'}, 'senam-3': { text: 'Aktivitas Gerak Dominan Senam', elemenTerkait: 'Terampil Bergerak'}, 'ritmik-3': { text: 'Aktivitas Gerak Berirama', elemenTerkait: 'Terampil Bergerak'}, 'kebugaran-3': { text: 'Aktivitas Kebugaran untuk Kesehatan', elemenTerkait: 'Bergaya Hidup Aktif' }, 'makanan-bergizi-3': { text: 'Memilih Makanan Bergizi', elemenTerkait: 'Memilih Hidup yang Menyehatkan'} }, 
        '4': { 'kombinasi-lokomotor-4': { text: 'Aktivitas Kombinasi Gerak Dasar Lokomotor', elemenTerkait: 'Terampil Bergerak'}, 'kombinasi-nonlokomotor-4': { text: 'Aktivitas Kombinasi Gerak Dasar Non-Lokomotor', elemenTerkait: 'Terampil Bergerak'}, 'kombinasi-manipulatif-4': { text: 'Aktivitas Kombinasi Gerak Dasar Manipulatif', elemenTerkait: 'Terampil Bergerak'}, 'senam-4': { text: 'Aktivitas Senam Lantai', elemenTerkait: 'Terampil Bergerak'}, 'ritmik-4': { text: 'Aktivitas Gerak Berirama', elemenTerkait: 'Terampil Bergerak'}, 'cedera-ringan-4': { text: 'Penanganan Cedera Ringan (P3K)', elemenTerkait: 'Memilih Hidup yang Menyehatkan'}, 'strategi-sederhana-4': { text: 'Strategi Gerak Sederhana', elemenTerkait: 'Belajar melalui Gerak' } }, 
        '5': { 'kesadaran-ruang-5': { text: 'Kesadaran Ruang', elemenTerkait: 'Terampil Bergerak' }, 'usaha-5': { text: 'Usaha (Konsep Waktu, Kekuatan, dan Gerak Mengalir)', elemenTerkait: 'Terampil Bergerak' }, 'hubungan-5': { text: 'Hubungan (Gabungan Konsep Gerak)', elemenTerkait: 'Terampil Bergerak' }, 'berpindah-5': { text: 'Berpindah', elemenTerkait: 'Terampil Bergerak' }, 'mengejar-lari-hindar-5': { text: 'Mengejar, Berlari, Menghindar', elemenTerkait: 'Terampil Bergerak' }, 'tekuk-regang-gulung-putar-5': { text: 'Menekuk, Meregang, Menggulung, dan Memutar', elemenTerkait: 'Terampil Bergerak' }, 'lompat-darat-5': { text: 'Melompat dan Mendarat', elemenTerkait: 'Terampil Bergerak' }, 'keseimbangan-5': { text: 'Keseimbangan', elemenTerkait: 'Terampil Bergerak' }, 'alih-berat-guling-5': { text: 'Mengalihkan Berat dan Berguling', elemenTerkait: 'Terampil Bergerak' }, 'tendang-voli-5': { text: 'Menendang dan Memvoli', elemenTerkait: 'Terampil Bergerak' }, 'lempar-tangkap-5': { text: 'Melempar dan Menangkap', elemenTerkait: 'Terampil Bergerak' }, 'oper-giring-5': { text: 'Mengoper dan Menggiring Bola', elemenTerkait: 'Terampil Bergerak' }, 'raket-dayung-5': { text: 'Keterampilan Memukul Menggunakan Raket dan Dayung', elemenTerkait: 'Terampil Bergerak' }, 'stik-panjang-5': { text: 'Keterampilan Memukul Menggunakan Stik/Pemukul Bergagang Panjang', elemenTerkait: 'Terampil Bergerak' }, 'kebugaran-kesehatan-5': { text: 'Pembelajaran Kebugaran Jasmani, Aktivitas Fisik, dan Kesehatan', elemenTerkait: 'Bergaya Hidup Aktif' }, 'irama-5': { text: 'Pembelajaran Gerak Berirama', elemenTerkait: 'Terampil Bergerak' }, 'senam-5': { text: 'Pembelajaran Olahraga Senam', elemenTerkait: 'Terampil Bergerak' }, 'permainan-5': { text: 'Pembelajaran dengan Permainan', elemenTerkait: 'Belajar melalui Gerak' }, 'integrasi-kurikulum-5': { text: 'Mengintegrasikan Pendekatan Tema Keterampilan di Seluruh Kurikulum', elemenTerkait: 'Belajar melalui Gerak' }, 'dukungan-program-5': { text: 'Membangun Dukungan untuk Program Pendidikan Jasmani', elemenTerkait: 'Belajar melalui Gerak' }, 'masa-depan-5': { text: 'Pendidikan Jasmani untuk Masa Depan Anak', elemenTerkait: 'Bergaya Hidup Aktif' } }, 
        '6': { 'invasi-6': { text: 'Aktivitas Permainan Invasi', elemenTerkait: 'Terampil Bergerak' }, 'net-6': { text: 'Aktivitas Permainan Net', elemenTerkait: 'Terampil Bergerak' }, 'lapangan-6': { text: 'Aktivitas Permainan Lapangan', elemenTerkait: 'Terampil Bergerak' }, 'beladiri-6': { text: 'Aktivitas Bela Diri Pencak Silat', elemenTerkait: 'Terampil Bergerak' }, 'senam-dominan-6': { text: 'Aktivitas Gerak Dominan Senam', elemenTerkait: 'Terampil Bergerak' }, 'irama-6': { text: 'Aktivitas Gerak Berirama', elemenTerkait: 'Terampil Bergerak' }, 'air-6': { text: 'Aktivitas Permainan dan Olahraga di Air', elemenTerkait: 'Terampil Bergerak' }, 'kebugaran-6': { text: 'Aktivitas Kebugaran untuk Kesehatan', elemenTerkait: 'Bergaya Hidup Aktif' }, 'bahaya-narkotika-6': { text: 'Mencegah Bahaya Narkotika, Zat-Zat Aditif, dan Obat Berbahaya Lainnya', elemenTerkait: 'Memilih Hidup yang Menyehatkan' } }
    };
    const modelPembelajaranDatabase = { 'Direct Instruction': { pendekatan: "Berpusat pada Guru (Teacher-Centered)", metode: ["Demonstrasi", "Latihan Terbimbing (Drill)", "Ceramah", "Imitasi"], deskripsi: "penjelasan dan peragaan langsung dari guru, diikuti oleh latihan yang terstruktur oleh siswa." }, 'Tactical Games Model': { pendekatan: "Berpusat pada Siswa (Student-Centered) dan Konstruktivis", metode: ["Permainan Taktis", "Diskusi Terbimbing", "Tanya Jawab", "Pemecahan Masalah"], deskripsi: "pengembangan pemahaman taktis dan pengambilan keputusan dalam konteks permainan." }, 'Sport Education Model': { pendekatan: "Berpusat pada Siswa (Student-Centered) dan Pembelajaran Kontekstual", metode: ["Musim Kompetisi", "Peran dalam Tim (Kapten, Wasit, Jurnalis)", "Festival Olahraga"], deskripsi: "pengalaman otentik dalam sebuah musim olahraga, di mana siswa belajar menjadi atlet yang kompeten, terpelajar, dan antusias." },'Cooperative Learning': { pendekatan: "Pembelajaran Kolaboratif dan Sosial", metode: ["Kerja Kelompok", "Jigsaw", "Think-Pair-Share", "Turnamen Tim"], deskripsi: "kerjasama siswa dalam kelompok kecil untuk mencapai tujuan belajar bersama." },'Project-Based Learning (PjBL)': { pendekatan: "Pembelajaran Berbasis Proyek dan Konstruktivis", metode: ["Proyek", "Penemuan (Discovery)", "Diskusi Kelompok", "Presentasi"], deskripsi: "pengorganisasian pembelajaran di sekitar proyek yang kompleks dan relevan bagi siswa." }, 'Problem-Based Learning (PBL)': { pendekatan: "Pembelajaran Berbasis Masalah dan Kontekstual", metode: ["Studi Kasus", "Pemecahan Masalah", "Diskusi", "Riset Mandiri"], deskripsi: "penyajian masalah nyata yang mendorong siswa untuk belajar secara mandiri." }, 'Inquiry Learning': { pendekatan: "Pembelajaran Penemuan (Inquiry-Based) dan Berpusat pada Siswa", metode: ["Eksplorasi", "Eksperimen", "Tanya Jawab", "Penemuan Terbimbing"], deskripsi: "siswa didorong untuk mengajukan pertanyaan dan menyelidiki untuk menemukan jawaban." }, 'Discovery Learning': { pendekatan: "Konstruktivis dan Berpusat pada Siswa", metode: ["Eksplorasi Terbuka", "Pemecahan Masalah", "Eksperimen", "Generalisasi Konsep"], deskripsi: "siswa menemukan konsep atau prinsip melalui eksplorasi mandiri dan pemecahan masalah yang disajikan oleh guru." },'Experiential Learning': { pendekatan: "Belajar melalui Pengalaman Langsung (Learning by Doing)", metode: ["Simulasi", "Role Playing", "Refleksi Pengalaman", "Aktivitas Outdoor"], deskripsi: "penekanan pada pengalaman konkret sebagai dasar observasi dan refleksi, di mana siswa belajar dari konsekuensi tindakan mereka." },'Blended Learning': { pendekatan: "Integrasi Teknologi dan Pembelajaran Tatap Muka", metode: ["Kelas Terbalik (Flipped Classroom)", "Rotasi Stasiun Belajar", "Proyek Online", "Diskusi Forum"], deskripsi: "kombinasi antara pembelajaran tatap muka di kelas dengan pembelajaran online yang memberikan fleksibilitas." } };
    const quotes = [ "Anak hebat, terus bergerak dan jadi kuat!", "Setiap lompatan membuatmu lebih tinggi, setiap lari membuatmu lebih cepat!", "Bermain bersama teman itu seru dan menyehatkan!", "Jangan takut salah, yang penting berani mencoba!", "Kamu adalah juara kecil hari ini!" ];
    const kelasByFase = { A: [1, 2], B: [3, 4], C: [5, 6] };

    async function callGemini(prompt) {
        const apiUrl = "/api/gemini"; 
        try {
            const response = await fetch(apiUrl, { 
                method: 'POST', 
                headers: { 'Content-Type': 'application/json' }, 
                body: JSON.stringify({ prompt: prompt }) 
            });
            if (!response.ok) { throw new Error(`Error dari server: ${response.status} ${response.statusText}`); }
            const result = await response.json();
            if (result.error) { return `Terjadi kesalahan dari server AI: ${result.error.message}`; }
            if (result.candidates && result.candidates[0]?.content?.parts[0]?.text) {
                return result.candidates[0].content.parts[0].text;
            }
            return "Maaf, format respons dari AI tidak valid.";
        } catch (error) {
            return `Terjadi kesalahan koneksi: ${error.message}.`;
        }
    }
    
    // ... (All other functions like showModal, getFormContext, populateKelas, populateMateri, etc. go here) ...
    // The code is omitted for brevity, but you should copy ALL JavaScript functions from the previous full code block.
});